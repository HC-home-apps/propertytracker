name: Weekly PropertyTracker Report

on:
  # Weekly schedule: Every Friday at 7 AM AEST (Thursday 20:00 UTC)
  # Friday chosen because: NSW VG publishes weekly, data refreshes at 5am,
  # and Friday gives weekend time to review if needed
  schedule:
    - cron: '0 20 * * 4'  # Every Thursday 20:00 UTC = Friday 7am AEST

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      force_download:
        description: 'Force re-download of data'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run (no Telegram message)'
        required: false
        default: 'false'
        type: boolean
      run_enrich:
        description: 'Run enrichment for new sales'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  TZ: 'Australia/Sydney'

jobs:
  run-tracker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Create config file
        run: |
          # Financial values are loaded from environment variables (SAVINGS_BALANCE,
          # SAVINGS_MONTHLY, PPOR_DEBT, IP_DEBT) - not written to files for security
          cat > config.yml << 'EOF'
          # PropertyTracker Configuration (GitHub Actions)
          # Financial values loaded from environment variables at runtime

          savings:
            current_balance: 0
            monthly_contribution: 0

          ppor:
            debt: 0
            selling_cost_rate: 0.02

          investment_property:
            address: "11 Alliance Ave, Revesby NSW 2212"
            debt: 0
            refinance_lvr_cap: 0.80
            valuation_haircut:
              bear: 0.90
              base: 0.95
              bull: 1.00

          # Segment definitions with filters
          segments:
            revesby_houses:
              display_name: "Revesby Houses (IP)"
              suburbs: [revesby, revesby heights]
              property_type: house
              role: proxy
              filters:
                area_min: 500
                area_max: 600
              description: "500-600sqm land, comparable to your IP"
              require_manual_review: true

            wollstonecraft_units:
              display_name: "Wollstonecraft Units (PPOR)"
              suburbs: [wollstonecraft]
              property_type: unit
              role: proxy
              filters:
                price_min: 1000000
                price_max: 1500000
                bedrooms: 2
                bathrooms: 1
                car_spaces: 1
              description: "2/1/1 units in Wollstonecraft, $1.0M-$1.5M range"
              require_manual_review: true

            lane_cove_houses:
              display_name: "Lane Cove Houses"
              suburbs: [lane cove, lane cove north, lane cove west]
              property_type: house
              role: target
              description: "Primary target - forever home"

            chatswood_houses:
              display_name: "Chatswood Houses"
              suburbs: [chatswood, chatswood west]
              property_type: house
              role: target
              description: "Alternative target"

          gap_tracker:
            proxy_segments:
              - revesby_houses
              - wollstonecraft_units
            target_segment: lane_cove_houses
            secondary_target: chatswood_houses

          report:
            format: simple
            show_proxies: [revesby_houses, wollstonecraft_units]
            show_targets: [lane_cove_houses, chatswood_houses]
            include_explanations: true
            show_recent_sales: true
            title: "PropertyTracker Report"

          data:
            source: nswpropertysalesdata
            districts:
              - 108  # Canterbury-Bankstown (Revesby)
              - 118  # North Sydney (Wollstonecraft)
              - 87   # Lane Cove
              - 145  # Willoughby (Chatswood)

          telegram:
            enabled: true

          thresholds:
            min_sample_monthly: 3
            min_sample_quarterly: 4
            min_sample_6month: 5
            gap_alert_threshold: 20000

          purchase_costs:
            rate: 0.01

          # Time adjustment rates for forward projections (conservative)
          time_adjustment:
            default_growth_rate: 0.05
            segment_growth_rates:
              revesby_houses: 0.05       # 5% - conservative for SW Sydney
              wollstonecraft_units: 0.04 # 4% - units are slower growth
              lane_cove_houses: 0.05     # 5% - established North Shore
              chatswood_houses: 0.05     # 5% - established North Shore

          schedule:
            frequency: weekly
            timezone: Australia/Sydney
          EOF

      - name: Install Playwright browser
        run: |
          playwright install firefox --with-deps

      - name: Create data directories
        run: |
          mkdir -p data/raw logs outputs

      - name: Download cached database
        uses: actions/cache@v4
        with:
          path: data/tracker.db
          key: tracker-db-${{ github.run_number }}
          restore-keys: |
            tracker-db-

      - name: Step 1 - Ingest new sales data
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_download }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi
          python -m tracker ingest $FORCE_FLAG

      - name: Step 1b - Ingest sold listings (DuckDuckGo multi-site search)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -m tracker ingest-google

      - name: Step 1b2 - Scrape Domain.com.au sold listings (headless browser)
        run: |
          python -m tracker ingest-domain-scrape || echo "Domain scrape failed (non-critical), continuing..."

      - name: Step 1c - Match provisional sales to VG
        run: |
          python -m tracker match-provisional

      - name: Step 2a - Enrich new Revesby sales
        if: github.event.inputs.run_enrich != 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DOMAIN_API_KEY: ${{ secrets.DOMAIN_API_KEY }}
        run: |
          python -m tracker enrich --segment revesby_houses --limit 20

      - name: Step 2b - Enrich new Wollstonecraft sales
        if: github.event.inputs.run_enrich != 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DOMAIN_API_KEY: ${{ secrets.DOMAIN_API_KEY }}
        run: |
          python -m tracker enrich --segment wollstonecraft_units --limit 20

      - name: Step 3 - Check pending reviews
        run: |
          echo "=== Pending Reviews (Revesby) ==="
          python -m tracker pending --segment revesby_houses || true
          echo "=== Pending Reviews (Wollstonecraft) ==="
          python -m tracker pending --segment wollstonecraft_units || true

      - name: Step 4 - Compute metrics
        run: |
          python -m tracker compute

      - name: Step 5 - Send report
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_REPORT_CHAT_ID: ${{ secrets.TELEGRAM_REPORT_CHAT_ID }}
          TELEGRAM_REPORT_CHAT_IDS: ${{ secrets.TELEGRAM_REPORT_CHAT_IDS }}
          SAVINGS_BALANCE: ${{ secrets.SAVINGS_BALANCE }}
          SAVINGS_MONTHLY: ${{ secrets.SAVINGS_MONTHLY }}
          PPOR_DEBT: ${{ secrets.PPOR_DEBT }}
          IP_DEBT: ${{ secrets.IP_DEBT }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          python -m tracker notify $DRY_RUN_FLAG

      - name: Step 6a - Process pending review responses
        if: github.event.inputs.run_enrich != 'false'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Process any button responses from previous reviews
          python -m tracker review-poll || echo "No pending responses"

      - name: Step 6b - Send new reviews with buttons
        if: github.event.inputs.run_enrich != 'false'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Send reviews with inline Yes/No buttons
          python -m tracker review-buttons --segment revesby_houses --limit 10 || echo "No pending Revesby reviews"
          python -m tracker review-buttons --segment wollstonecraft_units --limit 10 || echo "No pending Wollstonecraft reviews"

      - name: Save database to cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/tracker.db
          key: tracker-db-${{ github.run_number }}

      - name: Upload database backup
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: database-${{ github.run_number }}
          path: data/tracker.db
          retention-days: 90

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: logs-${{ github.run_number }}
          path: logs/
          retention-days: 30

  # Test job - runs on PRs and pushes
  test:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          pytest tests/ -v --cov=tracker --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false
