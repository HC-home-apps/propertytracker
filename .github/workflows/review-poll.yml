name: Process Review Response

on:
  # Triggered by Cloudflare Worker webhook when user taps a button
  repository_dispatch:
    types: [review-response]

  # Manual trigger (fallback)
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.11'

jobs:
  update-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download cached database
        uses: actions/cache@v4
        with:
          path: data/tracker.db
          key: tracker-db-${{ github.run_number }}
          restore-keys: |
            tracker-db-

      - name: Create minimal config
        run: |
          cat > config.yml << 'EOF'
          segments: {}
          EOF

      - name: Process review response
        if: github.event_name == 'repository_dispatch'
        env:
          SALE_IDS: ${{ toJson(github.event.client_payload.sale_ids) }}
          RESPONSE: ${{ github.event.client_payload.response }}
          SEGMENT_CODE: ${{ github.event.client_payload.segment_code }}
        run: |
          python -c "
          import os
          import json
          from datetime import datetime, timezone
          from tracker.db import Database

          db = Database('data/tracker.db')
          db.init_schema()

          sale_ids_json = os.environ.get('SALE_IDS', '[]')
          sale_ids = json.loads(sale_ids_json)
          response = os.environ['RESPONSE']
          segment = os.environ.get('SEGMENT_CODE', '')

          status = 'comparable' if response == 'yes' else 'not_comparable'
          use_in_median = 1 if response == 'yes' else 0
          now = datetime.now(timezone.utc).isoformat()

          total_updated = 0
          for sale_id in sale_ids:
              result = db.execute('''
                  UPDATE sale_classifications
                  SET review_status = ?, use_in_median = ?, reviewed_at = ?, updated_at = ?
                  WHERE sale_id = ?
              ''', (status, use_in_median, now, now, sale_id))
              total_updated += result
              print(f'{sale_id} ({segment}): {status}')

          print(f'Total rows updated: {total_updated}')
          db.close()
          "

      - name: Manual poll (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -m tracker review-poll || echo "No pending responses"

      - name: Save database to cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/tracker.db
          key: tracker-db-${{ github.run_number }}
